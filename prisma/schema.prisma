generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AgentClient {
  userId    String
  clientId  String
  createdAt DateTime @default(now())
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, clientId])
  @@index([clientId])
  @@index([userId])
}

model AgentVendor {
  userId    String
  vendorId  String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@id([userId, vendorId])
  @@index([userId])
  @@index([vendorId])
}

model VendorUser {
  vendorId  String
  userId    String
  role      VendorUserRole
  createdAt DateTime @default(now())
  Vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([vendorId, userId])
  @@index([vendorId])
  @@index([userId])
}

model Agreement {
  id                 String    @id
  clientId           String
  vendorId           String
  priceMode          PriceMode @default(BASE)
  discountPct        Float?
  overridePriceCents Int?
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime?
  Client             Client    @relation(fields: [clientId], references: [id])
  Vendor             Vendor    @relation(fields: [vendorId], references: [id])

  @@index([clientId])
  @@index([clientId, vendorId])
  @@index([vendorId])
}

model AuditLog {
  id          String   @id
  actorUserId String?
  entityType  String
  entityId    String
  action      String
  diff        Json?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model Cart {
  id              String     @id
  clientId        String
  createdByUserId String
  status          CartStatus @default(ACTIVE)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  Client          Client     @relation(fields: [clientId], references: [id])
  User            User       @relation(fields: [createdByUserId], references: [id])
  CartItem        CartItem[]

  @@index([clientId, status])
}

model CartItem {
  id              String        @id
  cartId          String
  vendorProductId String
  qty             Int
  unitPriceCents  Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  Cart            Cart          @relation(fields: [cartId], references: [id], onDelete: Cascade)
  VendorProduct   VendorProduct @relation(fields: [vendorProductId], references: [id])

  @@index([cartId])
  @@index([vendorProductId])
}

model CategoryGroup {
  id              String            @id
  name            CategoryGroupType @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ProductCategory ProductCategory[]
}

model Client {
  id     String  @id
  name   String
  region String?
  notes  String?

  // Address & Location
  fullAddress     String?
  shortAddress    String?
  deliveryAddress String?
  deliveryLat     Float?
  deliveryLng     Float?

  // Contact Info
  contactPerson String?
  email         String?
  phone         String?
  taxId         String? // P.IVA/C.F.

  // Display/UI
  pinColor String?
  hidden   Boolean @default(false)

  // Integration/Migration
  externalId String?  @unique // GentmoID
  freezco    Boolean? // Freezco flag
  mandanti   String? // Principals/Agents

  // Payment Integration (Phase 10)
  stripeCustomerId       String? @unique // Stripe Customer ID for payment processing
  defaultPaymentMethodId String? // Default payment method ID from Stripe
  hasPaymentMethod       Boolean @default(false) // Quick flag: does client have a payment method on file?

  // Tracking
  lastVisitAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  AgentClient  AgentClient[]
  Agreement    Agreement[]
  Cart         Cart[]
  ClientStats  ClientStats?
  ClientVendor ClientVendor[]
  DriverStop   DriverStop[]
  Order        Order[]
  User         User?

  @@index([region])
  @@index([email])
  @@index([hidden])
}

model ClientStats {
  id       String @id
  clientId String @unique

  // Visit/Contact Statistics
  totalVisits  Int @default(0)
  clientVisits Int @default(0) // visita dal cliente
  phoneCalls   Int @default(0) // telefonata
  emails       Int @default(0) // email
  other        Int @default(0) // altro

  // Business Statistics
  deliveryCount         Int @default(0) // consegna
  bankTransferCount     Int @default(0) // bonifico
  invoiceCount          Int @default(0) // fattura
  collectionCount       Int @default(0) // incasso
  failedCollectionCount Int @default(0) // incasso mancato
  extensionCount        Int @default(0) // proroga

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model ClientVendor {
  id               String             @id @default(cuid())
  clientId         String
  vendorId         String
  status           ClientVendorStatus @default(PENDING)
  approvedByUserId String?
  createdAt        DateTime           @default(now())
  approvedAt       DateTime?
  Client           Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  Vendor           Vendor             @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  ApprovedByUser   User?              @relation("ClientVendorApprovedBy", fields: [approvedByUserId], references: [id])

  @@unique([clientId, vendorId])
  @@index([clientId])
  @@index([vendorId])
  @@index([status])
}

model Delivery {
  id              String         @id
  orderId         String?        @unique
  subOrderId      String?        @unique
  driverId        String
  status          DeliveryStatus @default(ASSIGNED)
  notes           String?
  exceptionReason String?
  assignedAt      DateTime       @default(now())
  pickedUpAt      DateTime?
  inTransitAt     DateTime?
  deliveredAt     DateTime?
  exceptionAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  routeSequence   Int?
  Driver          Driver         @relation(fields: [driverId], references: [id])
  Order           Order?         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  SubOrder        SubOrder?      @relation(fields: [subOrderId], references: [id], onDelete: Cascade)

  @@index([assignedAt])
  @@index([driverId])
  @@index([driverId, routeSequence])
  @@index([status])
  @@index([orderId])
  @@index([subOrderId])
}

model Driver {
  id          String        @id
  name        String
  phone       String?
  status      DriverStatus  @default(OFFLINE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?
  Delivery    Delivery[]
  DriverShift DriverShift[]
  User        User?

  @@index([status])
}

model DriverShift {
  id                    String     @id @default(cuid())
  driverId              String
  vehicleId             String
  date                  DateTime
  startKm               Int
  startFuelLevel        FuelLevel
  startTime             DateTime
  endKm                 Int?
  endFuelLevel          FuelLevel?
  endTime               DateTime?
  closingNotes          String?
  cashReturnedConfirmed Boolean?   @default(false)
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  driver  Driver       @relation(fields: [driverId], references: [id])
  vehicle Vehicle      @relation(fields: [vehicleId], references: [id])
  stops   DriverStop[]

  @@index([driverId, date])
  @@index([driverId])
  @@index([vehicleId])
  @@index([date])
}

model DriverStop {
  id                 String           @id @default(cuid())
  shiftId            String
  clientId           String
  sequenceNumber     Int
  status             DriverStopStatus @default(PENDING)
  cashCollectedCents Int?
  bonCollectedCents  Int?
  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  shift  DriverShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  client Client      @relation(fields: [clientId], references: [id])

  @@index([shiftId, sequenceNumber])
  @@index([shiftId])
  @@index([clientId])
}

model Vehicle {
  id           String        @id @default(cuid())
  licensePlate String        @unique
  description  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  DriverShift  DriverShift[]
}

model Order {
  id                                   String      @id
  clientId                             String
  submitterUserId                      String
  status                               OrderStatus @default(DRAFT)
  region                               String?
  assignedAgentUserId                  String?
  notes                                String?
  createdAt                            DateTime    @default(now())
  updatedAt                            DateTime    @updatedAt
  deletedAt                            DateTime?
  orderNumber                          String      @unique
  totalCents                           Int
  deliveryAddress                      String?
  deliveryLat                          Float?
  deliveryLng                          Float?
  Delivery                             Delivery?
  User_Order_assignedAgentUserIdToUser User?       @relation("Order_assignedAgentUserIdToUser", fields: [assignedAgentUserId], references: [id])
  Client                               Client      @relation(fields: [clientId], references: [id])
  User_Order_submitterUserIdToUser     User        @relation("Order_submitterUserIdToUser", fields: [submitterUserId], references: [id])
  OrderItem                            OrderItem[]
  SubOrder                             SubOrder[]

  @@index([assignedAgentUserId])
  @@index([clientId])
  @@index([status])
}

model SubOrder {
  id             String         @id
  orderId        String
  vendorId       String
  status         SubOrderStatus @default(PENDING)
  subOrderNumber String         @unique
  subTotalCents  Int

  // VAT snapshot totals (N1.2) - captured at order time, nullable for historical orders
  netTotalCents   Int? // Sum of all line items net amounts
  vatTotalCents   Int? // Sum of all line items VAT amounts
  grossTotalCents Int? // Sum of all line items gross amounts

  // Payment tracking (Phase 11)
  stripeChargeId String?
  paidAt         DateTime?
  paymentStatus  PaymentStatus?

  // Payment failure tracking (Issue #104)
  paymentAttemptCount     Int       @default(0)
  lastPaymentAttemptAt    DateTime?
  nextPaymentRetryAt      DateTime?
  paymentLastErrorCode    String? // Stripe error code (sanitized, no PII)
  paymentLastErrorMessage String? // User-safe error message
  authorizationExpiresAt  DateTime? // 7 days from authorization
  requiresClientUpdate    Boolean   @default(false) // Flag for manual intervention

  // Fee tracking (accounting separation - Phase 11)
  // NOTE: Fees not deducted automatically until legal approval
  hydraFeeCents   Int? // Calculated Hydra platform fee in cents
  hydraFeeBps     Int? // Fee rate in basis points (e.g., 500 = 5.00%)
  hydraFeePercent Float? // Fee percentage applied (e.g., 0.05 for 5%) - backward compat

  // Fulfillment timestamps
  confirmedAt DateTime?
  readyAt     DateTime?
  canceledAt  DateTime?

  // Notes
  vendorNotes   String?
  internalNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  Order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Vendor    Vendor      @relation(fields: [vendorId], references: [id])
  OrderItem OrderItem[]
  Delivery  Delivery?

  @@index([orderId])
  @@index([vendorId])
  @@index([status])
  @@index([vendorId, status])
  @@index([paymentStatus, nextPaymentRetryAt]) // For payment retry cron job
}

model OrderItem {
  id              String   @id
  orderId         String
  vendorProductId String
  qty             Int
  unitPriceCents  Int
  lineTotalCents  Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  productName     String
  vendorName      String
  subOrderId      String?

  // VAT snapshot fields (N1.2) - captured at order time, nullable for historical orders
  taxProfileId   String? // FK to TaxProfile at time of order
  vatRateBps     Int? // VAT rate in basis points (e.g., 2200 = 22%)
  vatAmountCents Int? // Calculated VAT amount for this line
  netCents       Int? // Net amount (before VAT)
  grossCents     Int? // Gross amount (after VAT)

  Order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  VendorProduct VendorProduct @relation(fields: [vendorProductId], references: [id])
  SubOrder      SubOrder?     @relation(fields: [subOrderId], references: [id], onDelete: Cascade)
  TaxProfile    TaxProfile?   @relation(fields: [taxProfileId], references: [id])

  @@index([orderId])
  @@index([vendorProductId])
  @@index([subOrderId])
  @@index([taxProfileId])
}

model Product {
  id          String      @id
  categoryId  String
  name        String
  description String?
  unit        ProductUnit @default(PIECE)
  imageUrl    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  // Tax profile override (N1.1) - nullable means inherit from category
  taxProfileId String?

  ProductCategory ProductCategory @relation(fields: [categoryId], references: [id])
  VendorProduct   VendorProduct[]
  TaxProfile      TaxProfile?     @relation(fields: [taxProfileId], references: [id])

  @@index([categoryId])
  @@index([name])
  @@index([taxProfileId])
}

model ProductCategory {
  id        String   @id
  groupId   String
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Category tree support (N1.1)
  parentId String? // Self-ref for subcategories (null = top-level)

  // Tax profile (N1.1)
  taxProfileId String? // FK to TaxProfile

  Product       Product[]
  CategoryGroup CategoryGroup @relation(fields: [groupId], references: [id])

  // Category tree relations
  Parent   ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id])
  Children ProductCategory[] @relation("CategoryTree")

  // Tax profile relation
  TaxProfile TaxProfile? @relation(fields: [taxProfileId], references: [id])

  @@index([groupId])
  @@index([parentId])
  @@index([taxProfileId])
}

// Tax profile for Italian VAT rates (N1.1)
model TaxProfile {
  id          String  @id @default(cuid())
  name        String  @unique // "standard_22", "reduced_10", "super_reduced_4", "exempt_0"
  vatRateBps  Int // Basis points: 2200 = 22.00%, 1000 = 10.00%, 400 = 4.00%, 0 = 0.00%
  description String?
  isDefault   Boolean @default(false) // One profile can be the fallback default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ProductCategory ProductCategory[]
  Product         Product[]
  OrderItem       OrderItem[]

  @@index([vatRateBps])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                                    String        @id @default(cuid())
  email                                 String        @unique
  name                                  String?
  role                                  Role          @default(CLIENT)
  status                                UserStatus    @default(PENDING)
  approvedAt                            DateTime?
  approvedByUserId                      String?
  onboardingData                        Json?
  agentCode                             String?       @unique
  vendorId                              String?       @unique
  clientId                              String?       @unique
  createdAt                             DateTime      @default(now())
  updatedAt                             DateTime      @updatedAt
  deletedAt                             DateTime?
  emailVerified                         DateTime?
  driverId                              String?       @unique
  Account                               Account[]
  AgentClient                           AgentClient[]
  AgentVendor                           AgentVendor[]
  AuditLog                              AuditLog[]
  ClientVendorApprovals                 ClientVendor[] @relation("ClientVendorApprovedBy")
  VendorUser                            VendorUser[]
  Cart                                  Cart[]
  Order_Order_assignedAgentUserIdToUser Order[]       @relation("Order_assignedAgentUserIdToUser")
  Order_Order_submitterUserIdToUser     Order[]       @relation("Order_submitterUserIdToUser")
  Session                               Session[]
  Client                                Client?       @relation(fields: [clientId], references: [id])
  Driver                                Driver?       @relation(fields: [driverId], references: [id])
  Vendor                                Vendor?       @relation(fields: [vendorId], references: [id])

  @@index([email])
  @@index([role])
  @@index([status])
}

model Vendor {
  id                String  @id
  name              String
  region            String?
  notes             String?
  contactEmail      String?
  contactPhone      String?
  address           String?
  businessHours     String?
  defaultOrderNotes String?

  // Stripe Connect Integration (Phase 11)
  stripeAccountId String? @unique // Stripe Connect account ID for receiving payments
  chargesEnabled  Boolean @default(false) // Whether the vendor can accept charges
  payoutsEnabled  Boolean @default(false) // Whether the vendor can receive payouts

  // VAT pricing mode (N1.2)
  priceIncludesVat Boolean @default(false) // false = NET pricing (add VAT), true = GROSS pricing (VAT included)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?
  AgentVendor   AgentVendor[]
  Agreement     Agreement[]
  ClientVendor  ClientVendor[]
  User          User?
  VendorUser    VendorUser[]
  VendorProduct VendorProduct[]
  SubOrder      SubOrder[]

  @@index([region])
}

model VendorProduct {
  id             String      @id
  vendorId       String
  productId      String
  vendorSku      String
  basePriceCents Int
  currency       String      @default("EUR")
  stockQty       Int         @default(0)
  leadTimeDays   Int         @default(0)
  minOrderQty    Int?
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  deletedAt      DateTime?
  CartItem       CartItem[]
  OrderItem      OrderItem[]
  Product        Product     @relation(fields: [productId], references: [id])
  Vendor         Vendor      @relation(fields: [vendorId], references: [id])

  @@unique([vendorId, productId])
  @@index([isActive])
  @@index([productId])
  @@index([stockQty])
  @@index([vendorId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum CartStatus {
  ACTIVE
  ORDERED
}

enum CategoryGroupType {
  FOOD
  BEVERAGE
  SERVICES
}

enum DeliveryStatus {
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  EXCEPTION
}

enum DriverStatus {
  ONLINE
  OFFLINE
  BUSY
}

enum DriverStopStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum FuelLevel {
  EMPTY
  QUARTER
  HALF
  THREE_QUARTERS
  FULL
}

enum OrderStatus {
  DRAFT
  SUBMITTED
  CONFIRMED
  FULFILLING
  DELIVERED
  CANCELED
}

enum PriceMode {
  BASE
  DISCOUNT
  OVERRIDE
}

enum ProductUnit {
  KG
  L
  PIECE
  BOX
  SERVICE
}

enum Role {
  ADMIN
  AGENT
  VENDOR
  CLIENT
  DRIVER
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum VendorUserRole {
  OWNER
  STAFF
  AGENT
}

enum ClientVendorStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubOrderStatus {
  PENDING
  SUBMITTED
  CONFIRMED
  FULFILLING
  READY
  CANCELED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}
