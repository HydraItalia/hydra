generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AgentClient {
  userId    String
  clientId  String
  createdAt DateTime @default(now())
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, clientId])
  @@index([clientId])
  @@index([userId])
}

model AgentVendor {
  userId    String
  vendorId  String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@id([userId, vendorId])
  @@index([userId])
  @@index([vendorId])
}

model VendorUser {
  vendorId  String
  userId    String
  role      VendorUserRole
  createdAt DateTime       @default(now())
  Vendor    Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  User      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([vendorId, userId])
  @@index([vendorId])
  @@index([userId])
}

model Agreement {
  id                 String    @id
  clientId           String
  vendorId           String
  priceMode          PriceMode @default(BASE)
  discountPct        Float?
  overridePriceCents Int?
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime?
  Client             Client    @relation(fields: [clientId], references: [id])
  Vendor             Vendor    @relation(fields: [vendorId], references: [id])

  @@index([clientId])
  @@index([clientId, vendorId])
  @@index([vendorId])
}

model AuditLog {
  id          String   @id
  actorUserId String?
  entityType  String
  entityId    String
  action      String
  diff        Json?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model Cart {
  id              String     @id
  clientId        String
  createdByUserId String
  status          CartStatus @default(ACTIVE)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  Client          Client     @relation(fields: [clientId], references: [id])
  User            User       @relation(fields: [createdByUserId], references: [id])
  CartItem        CartItem[]

  @@index([clientId, status])
}

model CartItem {
  id              String        @id
  cartId          String
  vendorProductId String
  qty             Int
  unitPriceCents  Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  Cart            Cart          @relation(fields: [cartId], references: [id], onDelete: Cascade)
  VendorProduct   VendorProduct @relation(fields: [vendorProductId], references: [id])

  @@index([cartId])
  @@index([vendorProductId])
}

model CategoryGroup {
  id              String            @id
  name            CategoryGroupType @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ProductCategory ProductCategory[]
}

model Client {
  id     String  @id
  name   String
  region String?
  notes  String?

  // Address & Location
  fullAddress     String?
  shortAddress    String?
  deliveryAddress String?
  deliveryLat     Float?
  deliveryLng     Float?

  // Contact Info
  contactPerson String?
  email         String?
  phone         String?
  taxId         String? // P.IVA/C.F.

  // Display/UI
  pinColor String?
  hidden   Boolean @default(false)

  // Integration/Migration
  externalId String?  @unique // GentmoID
  freezco    Boolean? // Freezco flag
  mandanti   String? // Principals/Agents

  // Payment Integration (Phase 10)
  stripeCustomerId       String? @unique // Stripe Customer ID for payment processing
  defaultPaymentMethodId String? // Default payment method ID from Stripe
  hasPaymentMethod       Boolean @default(false) // Quick flag: does client have a payment method on file?

  // Tracking
  lastVisitAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  AgentClient   AgentClient[]
  Agreement     Agreement[]
  Cart          Cart[]
  ClientProfile ClientProfile?
  ClientStats   ClientStats?
  ClientVendor  ClientVendor[]
  DriverStop    DriverStop[]
  Order         Order[]
  User          User?

  @@index([region])
  @@index([email])
  @@index([hidden])
}

model ClientStats {
  id       String @id
  clientId String @unique

  // Visit/Contact Statistics
  totalVisits  Int @default(0)
  clientVisits Int @default(0) // visita dal cliente
  phoneCalls   Int @default(0) // telefonata
  emails       Int @default(0) // email
  other        Int @default(0) // altro

  // Business Statistics
  deliveryCount         Int @default(0) // consegna
  bankTransferCount     Int @default(0) // bonifico
  invoiceCount          Int @default(0) // fattura
  collectionCount       Int @default(0) // incasso
  failedCollectionCount Int @default(0) // incasso mancato
  extensionCount        Int @default(0) // proroga

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model ClientVendor {
  id               String             @id @default(cuid())
  clientId         String
  vendorId         String
  status           ClientVendorStatus @default(PENDING)
  approvedByUserId String?
  createdAt        DateTime           @default(now())
  approvedAt       DateTime?
  Client           Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  Vendor           Vendor             @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  ApprovedByUser   User?              @relation("ClientVendorApprovedBy", fields: [approvedByUserId], references: [id])

  @@unique([clientId, vendorId])
  @@index([clientId])
  @@index([vendorId])
  @@index([status])
}

model Delivery {
  id              String         @id
  orderId         String?        @unique
  subOrderId      String?        @unique
  driverId        String
  status          DeliveryStatus @default(ASSIGNED)
  notes           String?
  exceptionReason String?
  assignedAt      DateTime       @default(now())
  pickedUpAt      DateTime?
  inTransitAt     DateTime?
  deliveredAt     DateTime?
  exceptionAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  routeSequence   Int?
  Driver          Driver         @relation(fields: [driverId], references: [id])
  Order           Order?         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  SubOrder        SubOrder?      @relation(fields: [subOrderId], references: [id], onDelete: Cascade)

  @@index([assignedAt])
  @@index([driverId])
  @@index([driverId, routeSequence])
  @@index([status])
  @@index([orderId])
  @@index([subOrderId])
}

model Driver {
  id        String    @id @default(cuid())
  name      String
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Unique identifier for onboarded drivers (codice fiscale)
  taxCode String? @unique

  // Operational status (for delivery operations)
  status DriverStatus @default(OFFLINE)

  // Onboarding status (for registration workflow)
  onboardingStatus DriverOnboardingStatus @default(PENDING)
  approvedAt       DateTime?
  activatedAt      DateTime?
  suspendedAt      DateTime?
  suspendedReason  String?

  // Operational relations
  Delivery    Delivery[]
  DriverShift DriverShift[]

  // Onboarding relations
  profile      DriverProfile?
  licenses     DriverLicense[]
  documents    DriverDocument[]
  companyLinks DriverCompanyLink[]

  // User relation (1:1)
  User User?

  @@index([status])
  @@index([onboardingStatus])
}

model DriverShift {
  id                    String     @id @default(cuid())
  driverId              String
  vehicleId             String
  date                  DateTime
  startKm               Int
  startFuelLevel        FuelLevel
  startTime             DateTime
  endKm                 Int?
  endFuelLevel          FuelLevel?
  endTime               DateTime?
  closingNotes          String?
  cashReturnedConfirmed Boolean?   @default(false)
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  driver  Driver       @relation(fields: [driverId], references: [id])
  vehicle Vehicle      @relation(fields: [vehicleId], references: [id])
  stops   DriverStop[]

  @@index([driverId, date])
  @@index([driverId])
  @@index([vehicleId])
  @@index([date])
}

model DriverStop {
  id                 String           @id @default(cuid())
  shiftId            String
  clientId           String
  sequenceNumber     Int
  status             DriverStopStatus @default(PENDING)
  cashCollectedCents Int?
  bonCollectedCents  Int?
  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  shift  DriverShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  client Client      @relation(fields: [clientId], references: [id])

  @@index([shiftId, sequenceNumber])
  @@index([shiftId])
  @@index([clientId])
}

model Vehicle {
  id           String        @id @default(cuid())
  licensePlate String        @unique
  description  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  DriverShift  DriverShift[]
}

model Order {
  id                                   String      @id
  clientId                             String
  submitterUserId                      String
  status                               OrderStatus @default(DRAFT)
  region                               String?
  assignedAgentUserId                  String?
  notes                                String?
  createdAt                            DateTime    @default(now())
  updatedAt                            DateTime    @updatedAt
  deletedAt                            DateTime?
  orderNumber                          String      @unique
  totalCents                           Int
  deliveryAddress                      String?
  deliveryLat                          Float?
  deliveryLng                          Float?
  Delivery                             Delivery?
  User_Order_assignedAgentUserIdToUser User?       @relation("Order_assignedAgentUserIdToUser", fields: [assignedAgentUserId], references: [id])
  Client                               Client      @relation(fields: [clientId], references: [id])
  User_Order_submitterUserIdToUser     User        @relation("Order_submitterUserIdToUser", fields: [submitterUserId], references: [id])
  OrderItem                            OrderItem[]
  SubOrder                             SubOrder[]

  @@index([assignedAgentUserId])
  @@index([clientId])
  @@index([status])
}

model SubOrder {
  id             String         @id
  orderId        String
  vendorId       String
  status         SubOrderStatus @default(PENDING)
  subOrderNumber String         @unique
  subTotalCents  Int

  // VAT snapshot totals (N1.2) - captured at order time, nullable for historical orders
  netTotalCents   Int? // Sum of all line items net amounts
  vatTotalCents   Int? // Sum of all line items VAT amounts
  grossTotalCents Int? // Sum of all line items gross amounts

  // Payment tracking (Phase 11)
  stripeChargeId String?
  paidAt         DateTime?
  paymentStatus  PaymentStatus?

  // Payment failure tracking (Issue #104)
  paymentAttemptCount     Int       @default(0)
  lastPaymentAttemptAt    DateTime?
  nextPaymentRetryAt      DateTime?
  paymentLastErrorCode    String? // Stripe error code (sanitized, no PII)
  paymentLastErrorMessage String? // User-safe error message
  authorizationExpiresAt  DateTime? // 7 days from authorization
  requiresClientUpdate    Boolean   @default(false) // Flag for manual intervention

  // Fee tracking (accounting separation - Phase 11)
  // NOTE: Fees not deducted automatically until legal approval
  hydraFeeCents   Int? // Calculated Hydra platform fee in cents
  hydraFeeBps     Int? // Fee rate in basis points (e.g., 500 = 5.00%)
  hydraFeePercent Float? // Fee percentage applied (e.g., 0.05 for 5%) - backward compat

  // Fulfillment timestamps
  confirmedAt DateTime?
  readyAt     DateTime?
  canceledAt  DateTime?

  // Notes
  vendorNotes   String?
  internalNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  Order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Vendor    Vendor      @relation(fields: [vendorId], references: [id])
  OrderItem OrderItem[]
  Delivery  Delivery?

  @@index([orderId])
  @@index([vendorId])
  @@index([status])
  @@index([vendorId, status])
  @@index([paymentStatus, nextPaymentRetryAt]) // For payment retry cron job
}

model OrderItem {
  id              String   @id
  orderId         String
  vendorProductId String
  qty             Int
  unitPriceCents  Int
  lineTotalCents  Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  productName     String
  vendorName      String
  subOrderId      String?

  // VAT snapshot fields (N1.2) - captured at order time, nullable for historical orders
  taxProfileId   String? // FK to TaxProfile at time of order
  vatRateBps     Int? // VAT rate in basis points (e.g., 2200 = 22%)
  vatAmountCents Int? // Calculated VAT amount for this line
  netCents       Int? // Net amount (before VAT)
  grossCents     Int? // Gross amount (after VAT)

  Order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  VendorProduct VendorProduct @relation(fields: [vendorProductId], references: [id])
  SubOrder      SubOrder?     @relation(fields: [subOrderId], references: [id], onDelete: Cascade)
  TaxProfile    TaxProfile?   @relation(fields: [taxProfileId], references: [id])

  @@index([orderId])
  @@index([vendorProductId])
  @@index([subOrderId])
  @@index([taxProfileId])
}

model Product {
  id          String      @id
  categoryId  String
  name        String
  description String?
  unit        ProductUnit @default(PIECE)
  imageUrl    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  // Tax profile override (N1.1) - nullable means inherit from category
  taxProfileId String?

  ProductCategory ProductCategory @relation(fields: [categoryId], references: [id])
  VendorProduct   VendorProduct[]
  TaxProfile      TaxProfile?     @relation(fields: [taxProfileId], references: [id])
  ImportBatchRow  ImportBatchRow[]

  @@index([categoryId])
  @@index([name])
  @@index([taxProfileId])
}

model ProductCategory {
  id        String   @id
  groupId   String
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Category tree support (N1.1)
  parentId String? // Self-ref for subcategories (null = top-level)

  // Tax profile (N1.1)
  taxProfileId String? // FK to TaxProfile

  Product       Product[]
  CategoryGroup CategoryGroup @relation(fields: [groupId], references: [id])

  // Category tree relations
  Parent   ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id])
  Children ProductCategory[] @relation("CategoryTree")

  // Tax profile relation
  TaxProfile TaxProfile? @relation(fields: [taxProfileId], references: [id])

  @@index([groupId])
  @@index([parentId])
  @@index([taxProfileId])
}

// Tax profile for Italian VAT rates (N1.1)
model TaxProfile {
  id          String  @id @default(cuid())
  name        String  @unique // "standard_22", "reduced_10", "super_reduced_4", "exempt_0"
  vatRateBps  Int // Basis points: 2200 = 22.00%, 1000 = 10.00%, 400 = 4.00%, 0 = 0.00%
  description String?
  isDefault   Boolean @default(false) // One profile can be the fallback default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ProductCategory ProductCategory[]
  Product         Product[]
  OrderItem       OrderItem[]

  @@index([vatRateBps])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                                    String         @id @default(cuid())
  email                                 String         @unique
  name                                  String?
  role                                  Role           @default(CLIENT)
  status                                UserStatus     @default(ONBOARDING)
  approvedAt                            DateTime?
  approvedByUserId                      String?
  onboardingData                        Json?
  agentCode                             String?        @unique
  vendorId                              String?        @unique
  clientId                              String?        @unique
  createdAt                             DateTime       @default(now())
  updatedAt                             DateTime       @updatedAt
  deletedAt                             DateTime?
  emailVerified                         DateTime?
  driverId                              String?        @unique
  agentId                               String?        @unique
  Account                               Account[]
  AgentClient                           AgentClient[]
  AgentVendor                           AgentVendor[]
  AuditLog                              AuditLog[]
  ClientVendorApprovals                 ClientVendor[] @relation("ClientVendorApprovedBy")
  VendorUser                            VendorUser[]
  Cart                                  Cart[]
  ImportBatch                           ImportBatch[]
  Order_Order_assignedAgentUserIdToUser Order[]        @relation("Order_assignedAgentUserIdToUser")
  Order_Order_submitterUserIdToUser     Order[]        @relation("Order_submitterUserIdToUser")
  Session                               Session[]
  Client                                Client?        @relation(fields: [clientId], references: [id])
  Driver                                Driver?        @relation(fields: [driverId], references: [id])
  Vendor                                Vendor?        @relation(fields: [vendorId], references: [id])
  agent                                 Agent?         @relation(fields: [agentId], references: [id])

  MobileMagicToken   MobileMagicToken[]
  MobileRefreshToken MobileRefreshToken[]

  @@index([email])
  @@index([role])
  @@index([status])
}

model Vendor {
  id                String  @id
  name              String
  region            String?
  notes             String?
  contactEmail      String?
  contactPhone      String?
  address           String?
  businessHours     String?
  defaultOrderNotes String?

  // Stripe Connect Integration (Phase 11)
  stripeAccountId String? @unique // Stripe Connect account ID for receiving payments
  chargesEnabled  Boolean @default(false) // Whether the vendor can accept charges
  payoutsEnabled  Boolean @default(false) // Whether the vendor can receive payouts

  // VAT pricing mode (N1.2)
  priceIncludesVat Boolean @default(false) // false = NET pricing (add VAT), true = GROSS pricing (VAT included)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?
  AgentVendor   AgentVendor[]
  Agreement     Agreement[]
  ClientVendor  ClientVendor[]
  ImportBatch   ImportBatch[]
  User          User?
  VendorUser    VendorUser[]
  VendorProduct VendorProduct[]
  SubOrder      SubOrder[]
  VendorProfile          VendorProfile?
  ImportTemplate         ImportTemplate[]
  VendorCategoryMapping  VendorCategoryMapping[]

  // Driver onboarding relations
  driverCompanyLinks DriverCompanyLink[]
  driverInvites      DriverInvite[]

  @@index([region])
}

model VendorProduct {
  id             String      @id
  vendorId       String
  productId      String
  vendorSku      String
  basePriceCents Int
  currency       String      @default("EUR")
  stockQty       Int         @default(0)
  leadTimeDays   Int         @default(0)
  minOrderQty    Int?
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  deletedAt      DateTime?
  CartItem       CartItem[]
  ImportBatchRow ImportBatchRow[]
  OrderItem      OrderItem[]
  Product        Product     @relation(fields: [productId], references: [id])
  Vendor         Vendor      @relation(fields: [vendorId], references: [id])

  @@unique([vendorId, productId])
  @@index([isActive])
  @@index([productId])
  @@index([stockQty])
  @@index([vendorId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum CartStatus {
  ACTIVE
  ORDERED
}

enum CategoryGroupType {
  FOOD
  BEVERAGE
  SERVICES
}

enum DeliveryStatus {
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  EXCEPTION
}

enum DriverStatus {
  ONLINE
  OFFLINE
  BUSY
}

// Driver onboarding status (distinct from operational DriverStatus)
enum DriverOnboardingStatus {
  PENDING
  APPROVED
  ACTIVE
  SUSPENDED
  INACTIVE
  REJECTED
}

enum DriverIdDocumentType {
  ID_CARD
  PASSPORT
  DRIVING_LICENSE
}

enum DriverDocumentType {
  ID_DOCUMENT
  DRIVING_LICENSE
  SIGNED_GDPR_FORM
  ADR_CERTIFICATE
  CQC_CERTIFICATE
  MEDICAL_CERTIFICATE
  CRIMINAL_RECORD
  OTHER
}

// ── Agent Onboarding Enums ───────────────────────────────────────────────────

enum AgentType {
  MONOMANDATARIO // Exclusive agent (single principal)
  PLURIMANDATARIO // Non-exclusive agent (multiple principals)
}

enum AgentStatus {
  PENDING
  APPROVED
  ACTIVE
  SUSPENDED
  INACTIVE
  REJECTED
}

enum AgentDocumentType {
  ID_DOCUMENT
  TAX_CODE_CARD
  CHAMBER_OF_COMMERCE_EXTRACT // Visura camerale
  ENASARCO_CERTIFICATE
  SIGNED_GDPR_FORM
  OTHER
}

enum AgentPaymentMethod {
  BANK_TRANSFER
  CHECK
  OTHER
}

enum CompanyType {
  VENDOR
  LOGISTICS_PARTNER
}

enum DriverCompanyLinkStatus {
  PENDING
  ACTIVE
  INACTIVE
  REJECTED
}

enum DriverStopStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum FuelLevel {
  EMPTY
  QUARTER
  HALF
  THREE_QUARTERS
  FULL
}

enum OrderStatus {
  DRAFT
  SUBMITTED
  CONFIRMED
  FULFILLING
  DELIVERED
  CANCELED
}

enum PriceMode {
  BASE
  DISCOUNT
  OVERRIDE
}

enum ProductUnit {
  KG
  L
  PIECE
  BOX
  SERVICE
}

enum Role {
  ADMIN
  AGENT
  VENDOR
  CLIENT
  DRIVER
}

enum UserStatus {
  ONBOARDING
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum VendorUserRole {
  OWNER
  STAFF
  AGENT
}

enum ClientVendorStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubOrderStatus {
  PENDING
  SUBMITTED
  CONFIRMED
  FULFILLING
  READY
  CANCELED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum VendorDocumentType {
  CHAMBER_OF_COMMERCE_EXTRACT
  LEGAL_REP_ID
  CERTIFICATION
  SIGNED_CONTRACT
  SIGNED_GDPR_FORM
  OTHER
}

enum VendorPaymentMethod {
  BANK_TRANSFER
  DIRECT_DEBIT
  CHECK
  OTHER
}

enum VendorPaymentTerms {
  NET_30
  NET_60
  NET_90
  ON_DELIVERY
  PREPAID
  OTHER
}

// ── Vendor Onboarding Profile (1:1 with Vendor) ─────────────────────────────

model VendorProfile {
  id       String @id @default(cuid())
  vendorId String @unique

  // Section 1: General
  legalName     String
  tradeName     String?
  industry      String?
  description   String?
  foundedAt     DateTime?
  employeeCount Int?

  // Section 2: Legal & Tax
  vatNumber                     String?
  taxCode                       String?
  chamberOfCommerceRegistration String?
  registeredOfficeAddress       Json? // { street, city, province, postalCode, country }
  operatingAddress              Json? // same shape, optional
  pecEmail                      String?
  sdiRecipientCode              String? // max 7 chars
  taxRegime                     String?
  licenses                      String?

  // Section 3: Contacts (JSON)
  adminContact      Json // { fullName, role, email, phone } — required
  commercialContact Json // { fullName, role, email, phone } — required
  technicalContact  Json? // { fullName, email, phone }

  // Section 4: Banking
  bankAccountHolder      String?
  iban                   String?
  bankNameAndBranch      String?
  preferredPaymentMethod VendorPaymentMethod?
  paymentTerms           VendorPaymentTerms?
  invoicingNotes         String?

  // Section 6: Operational
  openingHours      String?
  closingDays       String?
  warehouseAccess   String?
  emergencyContacts Json? // [{ name, phone, role }]
  operationalNotes  String?

  // Section 7: Consents
  dataProcessingConsent   Boolean   @default(false)
  dataProcessingTimestamp DateTime?
  marketingConsent        Boolean   @default(false)
  marketingTimestamp      DateTime?
  logoUsageConsent        Boolean   @default(false)
  logoUsageTimestamp      DateTime?
  consentVersion          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Vendor   Vendor           @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  Document VendorDocument[]
}

// ── Vendor Document Metadata ─────────────────────────────────────────────────

model VendorDocument {
  id              String             @id @default(cuid())
  vendorProfileId String
  type            VendorDocumentType
  label           String
  fileName        String?
  notes           String?
  required        Boolean            @default(false)
  uploadedAt      DateTime?
  fileUrl         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  VendorProfile VendorProfile @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)

  @@index([vendorProfileId])
  @@index([vendorProfileId, type])
}

// ── Client Type Enum ─────────────────────────────────────────────────────────

enum ClientType {
  PRIVATE
  COMPANY
  RESELLER
  PARTNER
}

enum ClientDocumentType {
  ID_DOCUMENT
  TAX_CODE
  SIGNED_GDPR_FORM
  OTHER
}

// ── Client Onboarding Profile (1:1 with Client) ─────────────────────────────

model ClientProfile {
  id       String @id @default(cuid())
  clientId String @unique

  // Section 1: Personal Details (PRIVATE only)
  fullName           String?
  birthDate          DateTime?
  birthPlace         String?
  personalTaxCode    String?
  personalPhone      String?
  personalEmail      String?
  personalPecEmail   String?
  residentialAddress Json? // { street, city, province, postalCode, country }
  domicileAddress    Json? // same shape, optional
  idDocumentType     String?
  idDocumentNumber   String?
  idDocumentExpiry   DateTime?
  idDocumentIssuer   String?

  // Section 2: Company Details (COMPANY/RESELLER/PARTNER only)
  legalName               String?
  tradeName               String?
  vatNumber               String?
  companyTaxCode          String?
  sdiRecipientCode        String? // max 7 chars
  companyPecEmail         String?
  registeredOfficeAddress Json? // { street, city, province, postalCode, country }
  operatingAddress        Json? // same shape, optional
  adminContact            Json? // { fullName, email, phone }
  operationalContact      Json? // { fullName, email, phone }

  // Section 3: Commercial
  clientType ClientType

  // Section 4: Billing
  invoicingNotes String?

  // Section 6: Operational
  preferredContactHours String?
  specialRequirements   String?
  operationalNotes      String?

  // Section 7: Consents
  dataProcessingConsent   Boolean   @default(false)
  dataProcessingTimestamp DateTime?
  marketingConsent        Boolean   @default(false)
  marketingTimestamp      DateTime?
  consentVersion          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Client   Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  Document ClientDocument[]
}

// ── Client Document Metadata ─────────────────────────────────────────────────

model ClientDocument {
  id              String             @id @default(cuid())
  clientProfileId String
  type            ClientDocumentType
  label           String
  fileName        String?
  notes           String?
  required        Boolean            @default(false)
  uploadedAt      DateTime?
  fileUrl         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ClientProfile ClientProfile @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  @@index([clientProfileId, type])
}

// ── Driver Onboarding Profile (1:1 with Driver) ─────────────────────────────

model DriverProfile {
  id        String   @id @default(cuid())
  driverId  String   @unique
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Personal Data
  fullName    String
  birthDate   DateTime
  birthPlace  String
  nationality String   @default("Italiana")

  // Addresses
  residentialAddress Json
  domicileAddress    Json?

  // Contact
  phone    String
  email    String
  pecEmail String?

  // Identity Document
  idDocumentType   DriverIdDocumentType
  idDocumentNumber String
  idDocumentExpiry DateTime
  idDocumentIssuer String

  // Denormalized company reference (vendor-only for now)
  currentVendorId String?

  // Consents with timestamps
  dataProcessingConsent     Boolean   @default(false)
  dataProcessingTimestamp   DateTime?
  operationalCommsConsent   Boolean   @default(false)
  operationalCommsTimestamp DateTime?
  geolocationConsent        Boolean   @default(false)
  geolocationTimestamp      DateTime?
  imageUsageConsent         Boolean   @default(false)
  imageUsageTimestamp       DateTime?
  consentVersion            String    @default("1.0")

  notes String?
}

// ── Driver License (first-class table for expiry tracking) ──────────────────

model DriverLicense {
  id        String   @id @default(cuid())
  driverId  String
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // License Details (type validated by Zod, not DB enum)
  licenseType      String
  licenseNumber    String
  issueDate        DateTime
  expiryDate       DateTime
  issuingAuthority String

  // Flags
  isCertification  Boolean   @default(false)
  isVerified       Boolean   @default(false)
  verifiedAt       DateTime?
  verifiedByUserId String?

  // Optional document link
  documentId String?         @unique
  document   DriverDocument? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([expiryDate])
}

// ── Driver Document (upload-ready metadata) ─────────────────────────────────

model DriverDocument {
  id        String   @id @default(cuid())
  driverId  String
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Metadata
  type     DriverDocumentType
  label    String
  fileName String?
  notes    String?
  required Boolean            @default(false)

  // File storage (nullable until upload implemented)
  storageKey      String?
  storageProvider String?
  fileUrl         String?
  mimeType        String?
  sizeBytes       Int?
  uploadedAt      DateTime?

  // Expiry & verification
  expiryDate       DateTime?
  isVerified       Boolean   @default(false)
  verifiedAt       DateTime?
  verifiedByUserId String?

  // Back-reference for license docs
  license DriverLicense?

  @@index([driverId])
  @@index([type])
}

// ── Driver Company Link (company association) ───────────────────────────────

model DriverCompanyLink {
  id       String @id @default(cuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  // Polymorphic company reference
  companyType CompanyType
  vendorId    String?
  vendor      Vendor?     @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  // Link status
  status DriverCompanyLinkStatus @default(PENDING)
  role   String?

  // Timestamps
  linkedAt          DateTime  @default(now())
  activatedAt       DateTime?
  deactivatedAt     DateTime?
  deactivatedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NOTE: Partial unique indexes in SQL migration (Prisma can't express)
  @@index([driverId])
  @@index([vendorId])
  @@index([status])
}

// ── Driver Invite (invite-first flow) ───────────────────────────────────────

model DriverInvite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Vendor who sent the invite
  vendorId        String
  vendor          Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  invitedByUserId String?

  // Token
  token     String   @unique
  expiresAt DateTime

  // Consumption tracking
  consumedAt         DateTime?
  consumedByDriverId String?

  @@index([vendorId])
  @@index([expiresAt])
}

// ══════════════════════════════════════════════════════════════════════════════
// AGENT ONBOARDING MODELS
// ══════════════════════════════════════════════════════════════════════════════

// ── Agent (Core Entity) ──────────────────────────────────────────────────────

model Agent {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Legacy-compat fields (denormalized from profile)
  name  String
  phone String?
  email String?

  // Unique identifiers
  taxCode   String  @unique
  agentCode String? @unique

  // Onboarding workflow
  status          AgentStatus @default(PENDING)
  approvedAt      DateTime?
  suspendedAt     DateTime?
  suspendedReason String?

  // Relations
  profile   AgentProfile?
  documents AgentDocument[]
  user      User?

  @@index([status])
}

// ── Agent Profile (1:1, source of truth for onboarding data) ─────────────────

model AgentProfile {
  id        String   @id @default(cuid())
  agentId   String   @unique
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── Section 1: Dati Anagrafici ──────────────────────────────────────────────
  fullName    String
  birthDate   DateTime
  birthPlace  String
  nationality String   @default("Italiana")

  // Addresses (JSON: { street, city, province, postalCode, country })
  residentialAddress Json
  domicileAddress    Json?

  // Contact
  phone    String
  email    String
  pecEmail String?

  // ── Section 2: Dati Professionali ───────────────────────────────────────────
  agentType                 AgentType
  chamberRegistrationNumber String // Numero iscrizione Registro Imprese
  chamberRegistrationDate   DateTime // Data iscrizione
  chamberName               String // CCIAA (Camera di Commercio)
  professionalAssociations  String? // Albi/associazioni (free text)

  // Territories & Sectors (arrays for flexibility)
  coveredTerritories String[]
  sectors            String[]

  // ── Section 3: Dati Fiscali ─────────────────────────────────────────────────
  vatNumber                String // Partita IVA
  taxRegime                String // e.g., "Ordinario", "Forfettario"
  atecoCode                String // Codice ATECO
  sdiRecipientCode         String // Codice destinatario SDI (max 7 chars)
  invoicingPecEmail        String // PEC per fatturazione elettronica
  enasarcoNumber           String // Numero posizione ENASARCO
  enasarcoRegistrationDate DateTime // Data iscrizione ENASARCO

  // ── Section 4: Dati Bancari ─────────────────────────────────────────────────
  bankAccountHolder      String
  iban                   String
  bankNameBranch         String
  preferredPaymentMethod AgentPaymentMethod @default(BANK_TRANSFER)
  commissionNotes        String? // Note per fatturazione provvigioni

  // ── Section 5: Consents ─────────────────────────────────────────────────────
  dataProcessingConsent     Boolean   @default(false)
  dataProcessingTimestamp   DateTime?
  operationalCommsConsent   Boolean   @default(false)
  operationalCommsTimestamp DateTime?
  commercialImageConsent    Boolean   @default(false)
  commercialImageTimestamp  DateTime?
  consentVersion            String    @default("1.0")

  notes String?
}

// ── Agent Document (upload-ready metadata) ───────────────────────────────────

model AgentDocument {
  id        String   @id @default(cuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Metadata
  type     AgentDocumentType
  label    String
  fileName String?
  notes    String?
  required Boolean           @default(false)

  // File storage (nullable until upload implemented)
  storageKey      String?
  storageProvider String?
  fileUrl         String?
  mimeType        String?
  sizeBytes       Int?
  uploadedAt      DateTime?

  // Verification
  expiryDate       DateTime?
  isVerified       Boolean   @default(false)
  verifiedAt       DateTime?
  verifiedByUserId String?

  @@index([agentId])
  @@index([type])
}

// ══════════════════════════════════════════════════════════════════════════════
// CSV IMPORT STAGING MODELS
// ══════════════════════════════════════════════════════════════════════════════

enum ImportBatchStatus {
  DRAFT
  PARSING
  PARSED
  VALIDATING
  VALIDATED
  COMMITTING
  COMMITTED
  FAILED
}

enum ImportBatchRowStatus {
  PENDING
  VALID
  ERROR
  SKIPPED
  COMMITTED
}

enum ImportSourceType {
  TEXT
  FILE
}

enum ImportTemplateStatus {
  ACTIVE
  ARCHIVED
}

model ImportBatch {
  id               String            @id @default(cuid())
  vendorId         String
  createdByUserId  String
  status           ImportBatchStatus  @default(DRAFT)
  sourceType       ImportSourceType   @default(TEXT)
  originalFilename String?
  fileUrl          String?
  parseError       String?
  rowCount         Int               @default(0)
  errorCount       Int               @default(0)
  lockedAt         DateTime?
  lockedByUserId   String?
  committedAt      DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  Vendor        Vendor           @relation(fields: [vendorId], references: [id])
  CreatedByUser User             @relation(fields: [createdByUserId], references: [id])
  Rows          ImportBatchRow[]

  @@index([vendorId])
  @@index([createdByUserId])
  @@index([status])
}

model ImportBatchRow {
  id              String               @id @default(cuid())
  batchId         String
  rowIndex        Int
  rawData         Json
  normalizedData  Json?
  errors          Json?
  status          ImportBatchRowStatus  @default(PENDING)
  productId       String?
  vendorProductId String?

  Batch         ImportBatch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  Product       Product?       @relation(fields: [productId], references: [id])
  VendorProduct VendorProduct? @relation(fields: [vendorProductId], references: [id])

  @@unique([batchId, rowIndex])
  @@index([batchId])
  @@index([batchId, status])
}

model ImportTemplate {
  id        String               @id @default(cuid())
  vendorId  String
  name      String
  mapping   Json
  defaults  Json?
  status    ImportTemplateStatus @default(ACTIVE)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  Vendor Vendor @relation(fields: [vendorId], references: [id])

  @@unique([vendorId, name])
  @@index([vendorId])
  @@index([vendorId, status])
}

model VendorCategoryMapping {
  id             String   @id @default(cuid())
  vendorId       String
  rawCategory    String   // lowercased/trimmed vendor-supplied category string
  canonicalSlug  String   // slug from the canonical taxonomy registry
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  Vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, rawCategory])
  @@index([vendorId])
  @@index([canonicalSlug])
}

// ══════════════════════════════════════════════════════════════════════════════
// MOBILE AUTH TOKENS
// ══════════════════════════════════════════════════════════════════════════════

model MobileMagicToken {
  id        String    @id @default(cuid())
  tokenHash String    @unique
  userId    String
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model MobileRefreshToken {
  id        String    @id @default(cuid())
  tokenHash String    @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
